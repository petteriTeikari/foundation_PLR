# Dockerfile.test - Python-only test environment matching CI
#
# Lightweight image for running unit + guardrail tests.
# No R, no Node.js â€” Python dependencies only.
#
# Build: DOCKER_BUILDKIT=1 docker build -f Dockerfile.test -t foundation-plr-test .
# Run:   docker run --rm -e MPLBACKEND=Agg foundation-plr-test
#
# =============================================================================

# --- Builder stage: install Python deps ---
FROM python:3.11-slim-bookworm AS builder

RUN apt-get update && apt-get install -y --no-install-recommends \
    build-essential git libgomp1 && rm -rf /var/lib/apt/lists/*

COPY --from=ghcr.io/astral-sh/uv:0.9 /uv /usr/local/bin/uv
WORKDIR /project
COPY pyproject.toml uv.lock ./

ENV UV_PROJECT_ENVIRONMENT=/opt/venv
RUN --mount=type=cache,target=/root/.cache/uv \
    uv venv /opt/venv && uv sync --frozen --dev

# --- Final stage: slim runtime ---
FROM python:3.11-slim-bookworm

RUN apt-get update && apt-get install -y --no-install-recommends \
    git libgomp1 && rm -rf /var/lib/apt/lists/*

COPY --from=ghcr.io/astral-sh/uv:0.9 /uv /usr/local/bin/uv
COPY --from=builder /opt/venv /opt/venv

ENV VIRTUAL_ENV=/opt/venv PATH="/opt/venv/bin:$PATH"
ENV PYTHONPATH=/project/src PREFECT_DISABLED=1 MPLBACKEND=Agg

WORKDIR /project
COPY pyproject.toml uv.lock Makefile renv.lock .Rprofile ./
COPY src/ src/
COPY tests/ tests/
COPY configs/ configs/
COPY scripts/ scripts/

RUN mkdir -p data/r_data data/public figures/generated

CMD ["python", "-m", "pytest", "tests/", "-m", "unit or guardrail", \
     "--ignore=tests/test_docker_r.py", "--ignore=tests/test_docker_full.py", \
     "-n", "auto", "-v", "--tb=short"]
